<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.9" />
<title>The Tundra Build System</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>The Tundra Build System</h1>
<span id="author">Andreas Fredriksson</span><br />
<span id="email"><code>&lt;<a href="mailto:dep@defmacro.se">dep@defmacro.se</a>&gt;</code></span><br />
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>Tundra is a high-performance code build system designed to give the best
possible incremental build times even for very large software projects.</p></div>
<div class="paragraph"><p>Its design was motivated by the games industry where projects are huge and
iterative rebuilding common. In games, teams of 20-30 developers working on the
same multi-MLOC codebase is not uncommon. Each second spent by a build system
not building wastes productivity, especially when there are thousands of builds
every day!</p></div>
<div class="sect2">
<h3 id="_design_philosphy">Design Philosphy</h3>
<div class="paragraph"><p>Here are some philosophical ideas and how they have influenced the design of
Tundra.</p></div>
<div class="sect3">
<h4 id="_simple_is_fast">Simple is Fast</h4>
<div class="paragraph"><p>There are two parts to Tundra: a flexible Lua configuration front-end which
makes dependency graphs and a very fast build engine that only executes
commands. The Lua front-end only runs when needed (such as when files have been
added, or Lua files changed). The build engine can therefore run unimpeded when
the programmer is iterating on a build problem.</p></div>
<div class="paragraph"><p>The code has no external dependencies. Tundra uses Lua 5.1 (which is customized
slightly.)</p></div>
</div>
<div class="sect3">
<h4 id="_support_just_enough">Support just enough</h4>
<div class="paragraph"><p>Many modern build systems can sync code from a plethora of version control
systems, download files from HTTP and lots lots more. Tundra doesn&#8217;t do any of
those things. It is a relatively simple command execution platform with a Lua
configuration front-end. A smaller scope means Tundra is easier to optimize.</p></div>
</div>
<div class="sect3">
<h4 id="_utilize_multi_core_hardware">Utilize multi-core hardware</h4>
<div class="paragraph"><p>It is important that a build system can run multiple jobs at once. But it is
equally important to utilize all cores to do other things like file signing and
implicit dependency scanning. Tundra is one of very few (if any) build systems
that do this whenever possible. This design gives a nice speedup to incremental
builds where most of the time is spent signing and checking file metadata.</p></div>
</div>
<div class="sect3">
<h4 id="_reliably_support_code_generation">Reliably support code generation</h4>
<div class="paragraph"><p>Tundra is designed around the concept of build passes, which segment the input
dependency graph into serialized regions. Dependencies (even implicit
dependencies) can only point to nodes in the same or earlier passes. This
design makes it easy to reliably support code generation scenarios of arbitrary
complexity while still supporting fully multi-threaded execution whenever
possible.</p></div>
<div class="paragraph"><p>Many build systems have problems running a mix of code generation and regular
build workloads in parallel, because compilation steps might covertly try to
include generated files via <code>#include</code> statements. Instead of solving this
problem by exhaustively mapping out <code>#include</code> statements, Tundra forces you to
segment the order of code generation and compilation steps explicitly. This
divides the problem into two separate workloads that can execute fully in
parallel without unintended side effects.</p></div>
</div>
<div class="sect3">
<h4 id="_separate_configuration_and_building">Separate configuration and building</h4>
<div class="paragraph"><p>By default Tundra uses Lua as its scripting language, which gives it a
high-performance, powerful data collection front-end for free. However, to get
the maximum speed from builds, all build actions are carried out in
multi-threaded native code.</p></div>
<div class="paragraph"><p>It is also possible to use a custom configuration program to generate low-level
input for the build engine via a JSON data file.</p></div>
<div class="paragraph"><p>This clear separation between configuration and building ensures that build
speed is unaffected by bad scripting and it is easier to diagnose why a build
runs slowly.</p></div>
</div>
<div class="sect3">
<h4 id="_don_8217_t_guess">Don&#8217;t guess</h4>
<div class="paragraph"><p>Tundra doesn&#8217;t go out of its way to support auto-configuration of toolsets or
guessing what compiler you want to use. It assumes you can list the
configurations you care for up front. This speeds up incremental builds as no
time is wasted scanning for tools in the environment every time.</p></div>
<div class="paragraph"><p>For a game project, there may be millions of builds between adding a new
platform or configuration to a build system. Tools are also very brittle and
need a specific configuration to produce working builds. The time it will take
to support a new toolset will offset the time it takes to tell the build
system about it by several orders of magnitude.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hello_world">Hello, world</h2>
<div class="sectionbody">
<div class="paragraph"><p>A Tundra project requires the file <code>tundra.lua</code> which specifies what build
configurations are available for the project. It is analogous to a <code>Makefile</code>.
Here is a sample minimal <code>tundra.lua</code> file that creates a configuration
<code>macosx-gcc</code> which pulls in the stock <code>gcc</code> toolset. We also say that this
configuration is to be the default if nothing is specified when Tundra is run
on Mac OS X:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Build <span style="color: #FF0000">{</span>
    Units <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span>
        <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> hello <span style="color: #990000">=</span> Program <span style="color: #FF0000">{</span>
            Name <span style="color: #990000">=</span> <span style="color: #FF0000">"HelloWorld"</span><span style="color: #990000">,</span>
            Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"hello.c"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #000000">Default</span></span><span style="color: #990000">(</span>hello<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span><span style="color: #990000">,</span>
    Configs <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        Config <span style="color: #FF0000">{</span>
            Name <span style="color: #990000">=</span> <span style="color: #FF0000">"macosx-gcc"</span><span style="color: #990000">,</span>
            DefaultOnHost <span style="color: #990000">=</span> <span style="color: #FF0000">"macosx"</span><span style="color: #990000">,</span>
            Tools <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"gcc"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The funny <code>Units</code> function specifies the available targets using the "unit
syntax", a set of keywords and conventions designed to describe build target in
a high-level manner. This data will typically be big for bigger projects so
it can also be put in a separate file, in which case Units can be set to a
string which is taken as a filename.</p></div>
<div class="paragraph"><p>If we now run Tundra on this input, it will build our <code>HelloWorld</code> executable.
The output path shows that tundra has defaulted the variant to <code>debug</code> and the
subvariant to <code>default</code>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ tundra2
Cc hello<span style="color: #990000">.</span>c
Program t2-output/macosx-gcc-debug-default/HelloWorld
<span style="color: #990000">***</span> build success<span style="color: #990000">,</span> <span style="color: #993399">2</span> <span style="font-weight: bold"><span style="color: #0000FF">jobs</span></span> run</tt></pre></div></div>
<div class="paragraph"><p>The next mandatory step is of course to display the famous greeting:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ t2-output/macosx-gcc-debug-default/HelloWorld
hello<span style="color: #990000">,</span> world</tt></pre></div></div>
<div class="paragraph"><p>More examples can be found in the <code>examples</code> directory in the Tundra
distribution.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">Installation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_installing_a_binary_package">Installing a binary package</h3>
<div class="paragraph"><p>Binary packages for Windows are available, see the root <code>README.md</code> file of the
Tundra github page.</p></div>
<div class="paragraph"><p>Both installers and zip files are available. Choose the installer for a fully
automated setup, including adding Tundra to your <code>PATH</code>. The binary zips are
useful for DIY installs or to check into source control.</p></div>
</div>
<div class="sect2">
<h3 id="_installing_from_source">Installing from source</h3>
<div class="paragraph"><p>Tundra can be obtained from the official GIT repository:
<code>git://github.com:deplinenoise/tundra.git</code>. Tundra uses Google&#8217;s test framework
for the unit tests, which must be made available via the Git submodule
mechanism:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ git submodule init
$ git submodule update</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On Windows, there are two options for building:
</p>
<div class="ulist"><ul>
<li>
<p>
Use Visual Studio 2012. The solution file is <code>vs2012/Tundra.sln</code>.
         After building you will need to copy <code>vs2012/x64/Release/*.exe</code> to a <code>bin</code>
     directory of your choice. Copy the <code>scripts</code> directory so that is lives next
     to your <code>bin</code> directory.
</p>
</li>
<li>
<p>
Use MinGW. It should be enough to build using <code>mingw32-make</code>. The resulting
     binary ends up in <code>build</code>, and can be installed next to a <code>scripts</code> directory
     as desired. It is also possible to run this binary right away as it will find
     the <code>scripts</code> directory automatically from this location. This can be convenient
     if you plan to hack on Tundra a lot.
</p>
</li>
</ul></div>
</li>
<li>
<p>
On Mac OS X and other Unix-like platforms, use GNU Make.
</p>
<div class="ulist"><ul>
<li>
<p>
Type <code>make</code> to build an optimized version
</p>
</li>
<li>
<p>
Type <code>make CHECKED=yes</code> to build a debug version.
     Do this if you&#8217;re hacking on the C++ core.
</p>
</li>
<li>
<p>
Type <code>make install</code> to install Tundra into <code>/usr/local</code>
     (you can override the path with <code>PREFIX=/path</code>)
</p>
</li>
<li>
<p>
Type <code>make uninstall</code> to uninstall Tundra
</p>
</li>
<li>
<p>
Cross compilation for Windows is also supported:
</p>
<div class="ulist"><ul>
<li>
<p>
Type <code>make CROSSMINGW=yes</code> to build a windows version
</p>
</li>
<li>
<p>
Type <code>make CROSSMINGW=yes installer</code> to build a windows installer
</p>
</li>
<li>
<p>
Type <code>make CROSSMINGW=yes windows-zip</code> to build a windows binary zip
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
On FreeBSD you might need to rebuild world with the option
  <code>WITH_LIBCPLUSPLUS=yes</code> added to <code>/etc/src.conf</code> in order to have LLVM&#8217;s libc++
  available, or hack the <code>Makefile</code> a bit.
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_running_the_tests">Running the tests</h4>
<div class="paragraph"><p>To test the native code, run <code>build/t2-unittest</code>.</p></div>
<div class="paragraph"><p>To test the Lua scripts, run <code>build/t2-lua selftest</code>.</p></div>
<div class="paragraph"><p>To test the build system for regression, run <code>./run-tests.pl build/tundra2</code>.
The regression test suite currently only works on Intel-based UNIX-like
platforms. You will need to have <code>yasm</code> installed for the assembly include
scanning tests to work.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_bit_of_tundra_nomenclature">A bit of Tundra nomenclature</h2>
<div class="sectionbody">
<div class="paragraph"><p>Here are some terms and definitions used in Tundra and elsewhere in this document:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>configuration</strong> - A two-tuple value separated with a dash; usually in the
  format <code>host-toolset</code>. Two common examples are <code>win32-msvc</code> and <code>linux-gcc</code>.
  Configurations can load one or more toolsets.
</p>
</li>
<li>
<p>
<strong>variant</strong> - A variant of a configuration; such as a with or without debugging
  information. Variants serve as tags to filter settings against. By default,
  tundra provides three variants: <code>debug</code>, <code>production</code> and <code>release</code> but these
  can be overridden as desired.
</p>
</li>
<li>
<p>
<strong>subvariant</strong> - An additional axis of separation that is orthagonal to
  variants but serve the same purpose. By default there is only one subvariant
  called <code>default</code>. Tundra itself uses two subvariants to select between build with
  Lua files embedded (<code>standalone</code>) or with Lua files in the file system (<code>dev</code>).
</p>
</li>
<li>
<p>
<strong>build id</strong> - A four-tuple <code>host-toolset-variant-subvariant</code> used to fully
  identify a build. Available through <code>BUILD_ID</code> in the unit environment.
</p>
</li>
<li>
<p>
<strong>unit</strong> - A high-level declaration of a piece of software. Unit declarations
  appear as a syntactic elements in unit input files. Static and dynamic
  libraries, programs and .NET assemblies are examples of units. Unit
  declarations are passed through the <code>nodegen</code> layer to produce dependency
  graphs from the declarations.
</p>
</li>
<li>
<p>
<strong>environment</strong> - A data structure with key-value mappings used to track
  configuration data inside Tundra. Sometimes refers to the OS environment.
</p>
</li>
<li>
<p>
<strong>toolset</strong> - A set of commands (e.g. compiler, linker and so on) that can be
  used to produce output files. Multiple toolsets can be loaded into a single
  configuration as long as there is no overlap in their settings, that is, a .NET
  toolset like <code>mono</code> can coexists with something like <code>gcc</code>, but you can&#8217;t have
  two <code>gcc</code>-style toolsets loaded into the same configuration at once. Use different
  configurations for that.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_tundra_works">How Tundra works</h2>
<div class="sectionbody">
<div class="paragraph"><p>A Tundra build is more complex compared to a traditional build system such as
Make, mostly for performance reasons:</p></div>
<div class="ulist"><ul>
<li>
<p>
The main program (<code>tundra2</code>) is run
</p>
</li>
<li>
<p>
The driver will check to see if the DAG data is up to date
</p>
</li>
<li>
<p>
If it is not, the DAG generator (by default <code>t2-lua</code>) is called automatically
</p>
<div class="ulist"><ul>
<li>
<p>
Run the project&#8217;s <code>tundra.lua</code> script to set options
</p>
</li>
<li>
<p>
Load toolsets, syntax files and other information as required by the configuration script
</p>
</li>
<li>
<p>
Run the referred <code>Units</code> file (or function) in syntax mode to define the project&#8217;s build units
</p>
</li>
<li>
<p>
Evaluate the unit declarations and generate DAG nodes
</p>
</li>
<li>
<p>
The DAG is saved off to a JSON file for compilation into binary data for future builds
</p>
</li>
</ul></div>
</li>
<li>
<p>
The <code>tundra2</code> driver picks up the updated DAG data
</p>
</li>
<li>
<p>
Any stale output files that are no longer mentioned are deleted
</p>
</li>
<li>
<p>
Command line targets are analyzed to figure out what to build
</p>
</li>
<li>
<p>
The build engine runs
</p>
</li>
<li>
<p>
The build state is saved for subsequent runs
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_tundra_lua_file">The tundra.lua file</h2>
<div class="sectionbody">
<div class="paragraph"><p>The file <code>tundra.lua</code> is read by Tundra when you invoke it. This is a regular
Lua source file. Its purpose is to call the global <code>Build</code> function with a
declarative input describing the build session to Tundra. The following
sections are a reference of what you can place in the <code>Build</code> block.
Declarations within the block can appear in any order.</p></div>
<div class="listingblock">
<div class="title">Build block synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Build <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- Required</span></span>
    Units <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span>
    Configs <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

    <span style="font-style: italic"><span style="color: #9A1900">-- Optional</span></span>
    Variants <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    DefaultVariant <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span>
    SubVariants <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    DefaultSubVariant <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span>
    ScriptDirs <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    SyntaxExtensions <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    Passes <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    ContentDigestExtensions <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    Options <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sect2">
<h3 id="_units_required">Units (required)</h3>
<div class="paragraph"><p>The build block must be either a function, the (string) filename of a
secondary file containing unit declarations, or a table of
file/functions.</p></div>
<div class="paragraph"><p>Each file/function is separate because it uses a custom, extensible
syntax set which is suitable to define build system input. A common
name for external unit files is <code>"units.lua"</code>, but any valid filename
is OK.</p></div>
<div class="paragraph"><p>If not specified, unit definitions will be loaded from a <code>"units.lua"</code> file.</p></div>
</div>
<div class="sect2">
<h3 id="_configs_required">Configs (required)</h3>
<div class="paragraph"><p>The <code>Configs</code> key should be set to an array of configurations this build system
supports. Each configuration is in turn a <code>Config</code> table.</p></div>
<div class="sect3">
<h4 id="_config">Config</h4>
<div class="paragraph"><p>Config blocks describe configuration parameters that apply to all units in the
build for that configuration, such as include paths, libraries and so on.</p></div>
<div class="listingblock">
<div class="title">Config Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Config <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- Required</span></span>
    Name <span style="color: #990000">=</span> <span style="color: #FF0000">"...-..."</span><span style="color: #990000">,</span>
    Tools <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    SupportedHosts <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"..."</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

    <span style="font-style: italic"><span style="color: #9A1900">-- Optional</span></span>
    DefaultOnHost <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span> <span style="color: #990000">,</span>
    Inherit <span style="color: #990000">=</span> <span style="color: #990000">...,</span>
    Env <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    ReplaceEnv <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    Virtual <span style="color: #990000">=</span> <span style="color: #990000">...,</span>
    SubConfigs <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_config_name_property_required">Config Name property (required)</h4>
<div class="paragraph"><p>The name of this configuration. Configuration names must be formatted in a
dashed <code>platform-toolset</code> format. These two tokens form the first two in the
quad <code>platform-toolset-variant-subvariant</code> system Tundra uses to id builds.</p></div>
</div>
<div class="sect3">
<h4 id="_config_supportedhosts_property_required">Config SupportedHosts property (required)</h4>
<div class="paragraph"><p>The host platforms that this configuration will be generated for. Example
platform names are <code>linux</code> and <code>windows</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_config_tools_property_optional">Config Tools property (optional)</h4>
<div class="paragraph"><p>A list of tools this configuration uses. A tool specification is either a
string, indicating that the defaults for that tool are to be used, or a table
<code>{ "toolname"; Foo=1, Bar=".." }</code> passing arbitrary options to the tool to
configure it. Tools are loaded from the tool directory list.</p></div>
<div class="paragraph"><p>Projects can add their own tool script directories via a <code>ScriptDirs</code> array
property in the <code>Build</code> block.</p></div>
<div class="listingblock">
<div class="title">Config Tools Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Tools <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"foo"</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"qux"</span><span style="color: #990000">;</span> Foo <span style="color: #990000">=</span> <span style="color: #993399">10</span><span style="color: #990000">,</span> Bar <span style="color: #990000">=</span> <span style="color: #FF0000">"some value"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_config_defaultonhost_property_optional">Config DefaultOnHost property (optional)</h4>
<div class="paragraph"><p>If present, this config will be built by default when the host platform matches
the pattern. This is convenient to have the host&#8217;s native configuration build
in the default variant when you just type <code>tundra</code> in the shell. This property
can also be a table of patterns to match multiple host operating systems,
useful for example if multiple host operating systems can build a common
cross compilation config and you want that configuration to be the default
across all hosts.</p></div>
<div class="paragraph"><p>If no <code>DefaultOnHost</code> properties are set, nothing will build by default and a
configuration must be specified on the command line.</p></div>
</div>
<div class="sect3">
<h4 id="_config_env_property_optional">Config Env property (optional)</h4>
<div class="paragraph"><p>If present, must be set to a table of key-value bindings to append to the
environment for this configuration. This typically includes things such as
include paths (<code>CPPPATH</code>), C preprocessor defines (<code>CPPDEFS</code>) and C compiler
options (<code>CCOPTS</code>).</p></div>
<div class="listingblock">
<div class="title">Config Env Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Config <span style="color: #FF0000">{</span>
    Name <span style="color: #990000">=</span> <span style="color: #FF0000">"foo-bar"</span><span style="color: #990000">,</span>
    Env <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        CPPDEFS <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"FOO"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"BAR=BAZ"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        CCOPTS <span style="color: #990000">=</span> <span style="color: #FF0000">"-frobnicate"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_config_replaceenv_property_optional">Config ReplaceEnv property (optional)</h4>
<div class="paragraph"><p>Just like the Env block describe above, but replaces the settings rather than
appending them to the environment.</p></div>
<div class="listingblock">
<div class="title">Config ReplaceEnv Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Config <span style="color: #FF0000">{</span>
    Name <span style="color: #990000">=</span> <span style="color: #FF0000">"foo-bar"</span><span style="color: #990000">,</span>
    Tools <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"gcc"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    ReplaceEnv <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        CC <span style="color: #990000">=</span> <span style="color: #FF0000">"/my/other/gcc"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_config_inherit_property_optional">Config Inherit property (optional)</h4>
<div class="paragraph"><p>If present, must be set to a table. This table will be scanned for values if
they are not present in the Config table itself. This is useful to group common
settings between configs in external tables. These external tables can also
inherit settings further by applying a new <code>Inherit</code> property.</p></div>
<div class="listingblock">
<div class="title">Inherit Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">local</span></span> foo_common <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #0000FF">local</span></span> bar_common <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...,</span> Inherit <span style="color: #990000">=</span> foo_common<span style="color: #990000">,</span> <span style="color: #FF0000">}</span>

Build <span style="color: #FF0000">{</span>
  Configs <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
    Config <span style="color: #FF0000">{</span> <span style="color: #990000">...,</span> Inherit <span style="color: #990000">=</span> foo_common<span style="color: #990000">,</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    Config <span style="color: #FF0000">{</span> <span style="color: #990000">...,</span> Inherit <span style="color: #990000">=</span> bar_common<span style="color: #990000">,</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_config_virtual_property_optional">Config Virtual property (optional)</h4>
<div class="paragraph"><p>If specified, and set to <code>true</code>, this configuration is marked as virtual and
cannot be built directly from the command line. This is useful for
configurations that only work as subconfigurations in a cross-compilation
scenario.</p></div>
</div>
<div class="sect3">
<h4 id="_config_subconfigs_property_optional">Config SubConfigs property (optional)</h4>
<div class="paragraph"><p>If present, must be set to a mapping of identifiers to configuration names. The
named subconfigurations will be selectable via these identifiers using the
<code>SubConfig</code> selector in units. This feature enables multi-toolset builds; that
is, building parts of a program with different C compilers, or
cross-compilation where some parts of the build must be built with the target
compiler and some with the host compiler.</p></div>
<div class="listingblock">
<div class="title">Config SubConfigs Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Configs <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
    Config <span style="color: #FF0000">{</span>
        Name <span style="color: #990000">=</span> <span style="color: #FF0000">"foo-bar"</span><span style="color: #990000">,</span>
        Virtual <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    Config <span style="color: #FF0000">{</span>
        Name <span style="color: #990000">=</span> <span style="color: #FF0000">"foo-baz"</span><span style="color: #990000">,</span>
        Virtual <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...,</span>
    Config <span style="color: #FF0000">{</span>
        Name <span style="color: #990000">=</span> <span style="color: #FF0000">"foo-qux"</span><span style="color: #990000">,</span>
        SubConfigs <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
            abc <span style="color: #990000">=</span> <span style="color: #FF0000">"foo-bar"</span><span style="color: #990000">,</span>
            def <span style="color: #990000">=</span> <span style="color: #FF0000">"foo-baz"</span><span style="color: #990000">,</span>
            <span style="color: #990000">...</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
    <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_variants_optional">Variants (optional)</h3>
<div class="paragraph"><p>Specifies a list of variants and their options. If present, these variants
completely replace Tundra&#8217;s built-in variants. There must be atleast one
variant. A variant consists of a required <code>Name</code> property and an optional
<code>Options</code> table.</p></div>
<div class="listingblock">
<div class="title">Variants synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Variants <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">{</span> Name <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span> Options <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_variant_options">Variant Options</h4>
<div class="paragraph"><p>Previously, the only currently recognized option was &#8216;GeneratePdb&#8217;,
which caused the MSVC toolset to generate debugging files in PDB format.</p></div>
<div class="paragraph"><p>This option has however been superseded by the environment variable GENERATE_PDB.
If you wish to generate PDB files for all your targets, set the GENERATE_PDB variable
to anything but <code>0</code>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_passes_optional">Passes (optional)</h3>
<div class="paragraph"><p>The build block can contain an array of passes which can be used to place
barriers between groups of build jobs. This is required if files are generated
that can be discovered only as implicit dependencies. Passes have two
properties, <code>Name</code> and <code>BuildOrder</code>, both of which are required. Passes are
ordered with the lowest <code>BuildOrder</code> first.</p></div>
<div class="listingblock">
<div class="title">Passes Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Build <span style="color: #FF0000">{</span>
    <span style="color: #990000">...</span>
    Passes <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        Foo <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> Name<span style="color: #990000">=</span><span style="color: #FF0000">"..."</span><span style="color: #990000">,</span> BuildOrder <span style="color: #990000">=</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        Bar <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> Name<span style="color: #990000">=</span><span style="color: #FF0000">"..."</span><span style="color: #990000">,</span> BuildOrder <span style="color: #990000">=</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #990000">...</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_contentdigestextensions_optional">ContentDigestExtensions (optional)</h3>
<div class="paragraph"><p>By default Tundra computes signatures using file timestamps. If a timestamp has
changed, Tundra will consider the targets out of date. Sometimes it&#8217;s useful to
only consider a file changed when its content changes and ignore the timestamp.
This often comes up in builds that generate lots of source files.</p></div>
<div class="paragraph"><p>The <code>ContentDigestExtensions</code> block can contain an array of file extensions.
Files that end in these extensions will be signed using a SHA-1 digest of their
contents instead of the traditional timestamp.</p></div>
<div class="paragraph"><p>In this example, we&#8217;re specifying that C and C++ source files should be signed
using a hash of their contents rather than their timestamps. This means you can
<code>touch</code> them all you want and no rebuild will occur, you&#8217;ll need to actually
modify their contents to make that happen:</p></div>
<div class="listingblock">
<div class="title">ContentDigestExtensions Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Build <span style="color: #FF0000">{</span>
    <span style="color: #990000">...</span>
    ContentDigestExtensions <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">".c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">".h"</span><span style="color: #990000">,</span> <span style="color: #FF0000">".cpp"</span><span style="color: #990000">,</span> <span style="color: #FF0000">".hpp"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_options_optional">Options (optional)</h3>
<div class="paragraph"><p>The <code>Options</code> block is used to set advanced build engine options.</p></div>
<div class="paragraph"><p>Currently the only options is <code>MaxExpensiveJobs</code> which limits the maximum
number of concurrent "expensive" jobs. If your build includes heavy link steps
which might trash the system&#8217;s virtual memory reserves when run concurrently,
this option will constrain the parallelism of those jobs, and your swap file
will thank you.</p></div>
<div class="paragraph"><p>To flag a DAG node as expensive, pass <code>Expensive=true</code> to the dag node creator.
Currently linking programs and shared libraries is considered expensive by
default.</p></div>
<div class="paragraph"><p>If <code>MaxExpensiveJobs</code> is not specified, Tundra will run as many expensive jobs
as there are build threads&#8201;&#8212;&#8201;that is, there&#8217;s no limit.</p></div>
<div class="listingblock">
<div class="title">Options Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Build <span style="color: #FF0000">{</span>
    <span style="color: #990000">...</span>
    Options <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
      MaxExpensiveJobs <span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
   <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_unit_syntax">Unit Syntax</h2>
<div class="sectionbody">
<div class="paragraph"><p>This section describes the default syntax elements that are available for use
in the units file. You can add your own unit syntax via extension.</p></div>
<div class="sect2">
<h3 id="_configuration_filtering">Configuration Filtering</h3>
<div class="paragraph"><p>It is often desirable to include various bits of data for a certain
configuration only, for example to include a source file only in the debug
build of a program, or to include certain libraries only for a specific
toolset. Tundra has a general mechanism called configuration filtering which
supports this.</p></div>
<div class="paragraph"><p>Configuration filtering uses the key-value part of a list to introduce a key
<code>Config</code> into the list. The <code>Config</code> key can be set to either a single pattern
string or a list of patters. The items in the list will then be included only
when one of the config patterns match:</p></div>
<div class="listingblock">
<div class="title">Configuration Filtering</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">...</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"foo.c"</span><span style="color: #990000">;</span> Config <span style="color: #990000">=</span> <span style="color: #FF0000">"*-*-debug"</span> <span style="color: #FF0000">}</span> <span style="color: #990000">...</span>
<span style="color: #990000">...</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"bar.c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"qux.c"</span><span style="color: #990000">;</span> Config <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"*-foo-*"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"*-bar-*"</span> <span style="color: #FF0000">}</span> <span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>In order to combine multiple options all filtered lists can be nested
arbitrarily; the filtering process flattens these lists. The following example
results in <code>foo.c</code> always being included, while <code>bar.c</code> is only included in
debug builds, and <code>foo-gcc.c</code> is included if the toolset matches <code>gcc</code> or
<code>mingw</code>. So for the <code>linux-gcc-debug</code> configuration all three files will be
included.</p></div>
<div class="listingblock">
<div class="title">Configuration Filtering Flattening</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"foo.c"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"bar.c"</span><span style="color: #990000">;</span> Config <span style="color: #990000">=</span> <span style="color: #FF0000">"*-*-debug"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"foo-gcc.c"</span><span style="color: #990000">;</span> Config <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"*-gcc-*"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"*-mingw-*"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_native_units">Native Units</h3>
<div class="paragraph"><p>Native units are implemented by the <code>tundra.syntax.native</code> module in
conjunction with a toolset script (such as <code>gcc</code>, <code>msvc</code>, and others) and
provide support for building shared and static libraries as well as executables
with C, C++ and Objective-C tools. These unit types are selected through the
following keywords:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>Program</code> - specifies a program
</p>
</li>
<li>
<p>
<code>StaticLibrary</code> - specifies a static library (archive)
</p>
</li>
<li>
<p>
<code>SharedLibrary</code> - specifies a shared library (dll)
</p>
</li>
<li>
<p>
<code>ExternalLibrary</code> - specifies an "external library" (a collection of settings)
</p>
</li>
<li>
<p>
<code>ObjGroup</code> - a set of object files (a static library, without the library part)
</p>
</li>
</ul></div>
<div class="paragraph"><p>All these follow the same synopsis:</p></div>
<div class="listingblock">
<div class="title">Native Unit Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>unit type<span style="color: #990000">&gt;</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- required</span></span>
    Name <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span>

    <span style="font-style: italic"><span style="color: #9A1900">-- optional</span></span>
    Config <span style="color: #990000">=</span> <span style="color: #990000">...,</span>
    Target <span style="color: #990000">=</span> <span style="color: #990000">...,</span>
    Propagate <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    SourceDir <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span>
    Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>      <span style="font-style: italic"><span style="color: #9A1900">-- config filtered</span></span>
    Depends <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>      <span style="font-style: italic"><span style="color: #9A1900">-- config filtered</span></span>
    Defines <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>      <span style="font-style: italic"><span style="color: #9A1900">-- config filtered</span></span>
    Libs <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>         <span style="font-style: italic"><span style="color: #9A1900">-- config filtered</span></span>
    Frameworks <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>   <span style="font-style: italic"><span style="color: #9A1900">-- config filtered</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_native_unit_name_property_required">Native Unit Name property (required)</h4>
<div class="paragraph"><p>The <code>Name</code> property must always be set to a unique name. These names are
exposed on the command line (e.g. <code>tundra foo</code> will build the unit <code>foo</code>) and
are also used as stems when computing output filenames. For example, a
<code>Program</code> unit <code>bar</code> might end up as <code>bar.exe</code> on Windows.</p></div>
<div class="paragraph"><p>Stay away from funny characters in the names, alphanumeric is a safe bet.</p></div>
</div>
<div class="sect3">
<h4 id="_native_unit_config_property">Native Unit Config property</h4>
<div class="paragraph"><p>Specifies what configuration(s) this unit will be present in. Configuration
pattern matching is applied as usual. For example, to include a unit only in
debug, you could say: <code>Config = "*-*-debug"</code> and to include a unit only for two
toolsets you could say <code>Config = { "foo-bar-*", "baz-qux-*" }</code>.</p></div>
<div class="paragraph"><p>When a unit is filtered out like this it is replaced by a null node in the DAG,
but it will still be present so there&#8217;s no need to remove it from depenency
lists.</p></div>
</div>
<div class="sect3">
<h4 id="_native_unit_propagate_property">Native Unit Propagate property</h4>
<div class="paragraph"><p>A nested block of settings to be propagated onto units that depend on this
unit. This is mostly useful for the <code>ExternalLibrary</code> unit type which serves as
a bag of settings, but it can occasionally be useful with other unit types such
as shared libraries to push say a certain define into the compilation options
of everyone who links to this library. The propagate block can contain <code>Libs</code>,
<code>Defines</code>, and so on.</p></div>
<div class="listingblock">
<div class="title">Native Unit Propagate synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>unit type<span style="color: #990000">&gt;</span> <span style="color: #FF0000">{</span>
    <span style="color: #990000">...</span>
    Propagate <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        <span style="color: #990000">...</span>
        Key <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> Value<span style="color: #990000">,</span> Value<span style="color: #990000">,</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>For example, to push a define <code>ZLIB_DLL</code> onto users of a library, one might use
the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>SharedLibrary <span style="color: #FF0000">{</span>
    Name <span style="color: #990000">=</span> <span style="color: #FF0000">"zlib"</span><span style="color: #990000">,</span>
    Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    Propagate <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        Defines <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"ZLIB_DLL"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_native_unit_sourcedir_property">Native Unit SourceDir property</h4>
<div class="paragraph"><p>If present, specifies a prefix to be applied to all files in the <code>Sources</code> list.</p></div>
</div>
<div class="sect3">
<h4 id="_native_unit_sources_property">Native Unit Sources property</h4>
<div class="paragraph"><p>An arbitrarily nested list of source files and filters. Elements in the lists
can be either strings which are taken to be source files, or nodes, in which
case their output files are used. It is therefore possible to call source
generators in this block and then include their output files as inputs directly
to the unit.</p></div>
</div>
<div class="sect3">
<h4 id="_native_unit_depends_property">Native Unit Depends property</h4>
<div class="paragraph"><p>A list of unit names which are the dependencies of this unit. Depending on a
library unit has the side effect of linking with that archive. All <code>Propagate</code>
blocks from dependencies will be applied to the depending unit.</p></div>
</div>
<div class="sect3">
<h4 id="_native_unit_defines_property">Native Unit Defines property</h4>
<div class="paragraph"><p>A list of C preprocessor defines (strings), either of the style <code>"FOO"</code> or <code>"FOO=BAR"</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_native_unit_libs_property">Native Unit Libs property</h4>
<div class="paragraph"><p>A list of external libraries to be fed to the linker. Typically very platform
specific and thus it is common that every lib is wrapped in a configuration
block, like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Libs <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"kernel32.lib"</span><span style="color: #990000">;</span> Config <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"win32-*-*"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"win64-*-*"</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"pthread"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"m"</span><span style="color: #990000">;</span> Config <span style="color: #990000">=</span> <span style="color: #FF0000">"linux-*-*"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_native_unit_frameworks_property">Native Unit Frameworks property</h4>
<div class="paragraph"><p>This is a Mac OS X-only feature to specify frameworks to include from and link
against. Currently these is no way to select a version, so the list includes
only framework names as strings.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_c_units">C# Units</h3>
<div class="paragraph"><p>Tundra has basic support for building C# .NET assemblies. The following unit types
are supported:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>CSharpExe</code> - Builds a C# executable
</p>
</li>
<li>
<p>
<code>CSharpLib</code> - Builds a C# library (dll)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="title">C# Unit Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>unit type<span style="color: #990000">&gt;</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- required</span></span>
    Name <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span>

    <span style="font-style: italic"><span style="color: #9A1900">-- optional</span></span>
    Config <span style="color: #990000">=</span> <span style="color: #990000">...,</span>
    SourceDir <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span>
    References <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>   <span style="font-style: italic"><span style="color: #9A1900">-- config filtered</span></span>
    Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>      <span style="font-style: italic"><span style="color: #9A1900">-- config filtered</span></span>
    Depends <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>      <span style="font-style: italic"><span style="color: #9A1900">-- config filtered</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_rust_units">Rust Units</h3>
<div class="paragraph"><p>Tundra has basic support for Rust programs, crates and shared libraries. The following unit types
are supported:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>RustProgram</code> - Builds a Rust executable
</p>
</li>
<li>
<p>
<code>RustCrate</code> - Builds a Rust create
</p>
</li>
<li>
<p>
<code>RustSharedLibrary</code> - Builds a Rust library (dll)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="title">Rust Unit Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>unit type<span style="color: #990000">&gt;</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- required</span></span>
    Name <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">-- name must match name in Cargo.toml</span></span>
    CargoConfig <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span>
    Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...,</span> <span style="color: #FF0000">"path/to/project/build.rs"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- optional</span></span>
    Depends <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>      <span style="font-style: italic"><span style="color: #9A1900">-- config filtered</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Tundra will call Cargo to build Rust projects so a Cargo.toml needs to be
configured (which is the standard way to setup Rust projects) Cargo doesn&#8217;t support
command-line args for linking libs so Tundra will set some env variables that
a Cargo build script that will use to link with the correct libs.</p></div>
<div class="paragraph"><p>The build.rs will need to look like this (if you use your own the following code
needs to be added)</p></div>
<div class="listingblock">
<div class="title">Rust build.rs Synopsis</div>
<div class="content">
<pre><code>use std::env;

fn main() {
    let tundra_dir = env::var("TUNDRA_OBJECTDIR").unwrap_or("".to_string());
    let libs = env::var("TUNDRA_STATIC_LIBS").unwrap_or("".to_string());

    let native_libs = libs.split(" ");

    println!("cargo:rustc-link-search=native={}", tundra_dir);

    for lib in native_libs {
        println!("cargo:rustc-link-lib=static={}", lib);
        println!("cargo:rerun-if-changed={}", lib);
    }
}</code></pre>
</div></div>
<div class="paragraph"><p>It is also possible to override the Cargo command line and add flags to rustc</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Env <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">-- Extra cargo options</span></span>
        RUST_CARGO_OPTS <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">{</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">;</span> Config <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="font-style: italic"><span style="color: #9A1900">-- Extra flags for rustc, this shows how to prefer-dynamic linking</span></span>
        RUST_OPTS <span style="color: #990000">=</span> <span style="color: #FF0000">"-C prefer-dynamic"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This can be useful for using Cargo&#8217;s built-in support for testing or enabling
more verbose output for example.</p></div>
<div class="paragraph"><p>In the examples/rust directory in the Tundra distribution there is examples
that shows how this is used in practice.</p></div>
<div class="paragraph"><p>Notice about Windows: Due to a bug that was detected in Cargo when implementing
this feature Rust 1.7+ (Beta) is required on Windows.</p></div>
</div>
<div class="sect2">
<h3 id="_syntax_extensions">Syntax Extensions</h3>
<div class="paragraph"><p>Tundra provides a small set of syntax extensions by default. To use syntax
extensions, simply <code>require</code> their Lua package names in your <code>units.lua</code> or
<code>tundra.lua</code> file. To add your own directories to the <code>require</code> search path,
refer to the <code>ScriptDirs</code> option.</p></div>
<div class="sect3">
<h4 id="_file_globbing">File Globbing</h4>
<div class="paragraph"><p>The <code>tundra.syntax.glob</code> extension provides file globbing (pattern matching
over filenames.) It is a convenient way to use the filesystem as the index of
what files to build rather than to manually type every file out in the
<code>Sources</code> list. You can also combine the two for greater control by mixing
globs and filenames.</p></div>
<div class="paragraph"><p>Globs come in two versions, <code>Glob</code> and <code>FGlob</code>.</p></div>
<div class="listingblock">
<div class="title">Glob Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Glob <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- required</span></span>
    Dir <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span>
    Extensions <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">".ext"</span><span style="color: #990000">,</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- optional</span></span>
    Recursive <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">-- default: true</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p><code>Glob</code> works by scanning <code>Dir</code> for files matching any of the extensions passed
in the <code>Extensions</code> list. By default, it will recurse into subdirectories, but
you can disable this behaviour by passing <code>Recursive = false</code>. In this example
we&#8217;re getting all <code>.c</code> and <code>.cpp</code> files from <code>my_dir</code>.</p></div>
<div class="listingblock">
<div class="title">Glob Example</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Program <span style="color: #FF0000">{</span>
    <span style="color: #990000">...</span>
    Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> Glob <span style="color: #FF0000">{</span> Dir <span style="color: #990000">=</span> <span style="color: #FF0000">"my_dir"</span><span style="color: #990000">,</span> Extensions <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">".c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">".cpp"</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Sometimes you want to get the files from the file system but some of them are
only to be compiled for specific configurations. A common scenario is when
there are platform-specific subdirectories with source files for that platform
only. <code>FGlob</code> extends <code>Glob</code> and adds a list of filters to apply after the file
list has been retrieved:</p></div>
<div class="listingblock">
<div class="title">FGlob Synopsis</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>FGlob <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- required</span></span>
    Dir <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span>
    Extensions <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">".ext"</span><span style="color: #990000">,</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    Filters <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">{</span> Pattern <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span><span style="color: #990000">,</span> Config <span style="color: #990000">=</span> <span style="color: #FF0000">"..."</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #990000">...</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- optional</span></span>
    Recursive <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">-- default: true</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <code>Pattern</code> attributes are regular Lua patterns that are matched against the
relative filename returned by the glob. To make patterns portable (and to save
typing), globs always return their filenames with forward slashes. In this
example, we&#8217;re tagging files in the <code>debug</code> directory for a specific
configuration only, and we&#8217;re tagging files with <code>win32</code> anywhere in the
filename for that platform:</p></div>
<div class="listingblock">
<div class="title">FGlob Example</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Program <span style="color: #FF0000">{</span>
    <span style="color: #990000">...</span>
    Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        FGlob <span style="color: #FF0000">{</span>
            Dir <span style="color: #990000">=</span> <span style="color: #FF0000">"my_dir"</span><span style="color: #990000">,</span>
            Extensions <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">".c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">".cpp"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            Filters <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">{</span> Pattern <span style="color: #990000">=</span> <span style="color: #FF0000">"/debug/"</span><span style="color: #990000">;</span> Config <span style="color: #990000">=</span> <span style="color: #FF0000">"*-*-debug"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">{</span> Pattern <span style="color: #990000">=</span> <span style="color: #FF0000">"win32"</span><span style="color: #990000">;</span> Config <span style="color: #990000">=</span> <span style="color: #FF0000">"win32-*-*"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">{</span> Pattern <span style="color: #990000">=</span> <span style="color: #FF0000">"[/\\]_[^/\\]*$"</span><span style="color: #990000">;</span> Config <span style="color: #990000">=</span> <span style="color: #FF0000">"ignore"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If you wish to exclude files based on a pattern you can specify a configuration
that doesn&#8217;t exist. In the above example the pattern <code>[/\]_[^/\]*$</code> will ignore all
files where the file name starts with <code>_</code>.</p></div>
<div class="paragraph"><p>The initial seperator is necessary as tundra passes the full path before
applying the filter (note: we need a character class that matches both POSIX and
Win32 style paths if we want this to work on all platforms).</p></div>
<div class="paragraph"><p>Lua patterns are not regular expressions but they are closely related. Instead
of using backslash, <code>%</code> is used to reference predefined character classes or
escape reserved characters but there&#8217;s no support for repetitions of captures
or alternations.</p></div>
</div>
<div class="sect3">
<h4 id="_parser_generation_bison_amp_flex">Parser Generation (Bison &amp; Flex)</h4>
<div class="paragraph"><p>To run <code>bison</code> and <code>flex</code> to generate parsers and lexers, import the
<code>tundra.syntax.bison</code> syntax extension. The extension doesn&#8217;t assume any
particular name or path to either <code>bison</code> or <code>flex</code> so you must define them
through the environment:</p></div>
<div class="listingblock">
<div class="title">Bison/Flex Example</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">...</span>
Env <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
    BISON <span style="color: #990000">=</span> <span style="color: #FF0000">"bison"</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">-- specify your own path if needed</span></span>
    BISONOPT <span style="color: #990000">=</span> <span style="color: #FF0000">""</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">-- specify addtional options if needed</span></span>
    FLEX <span style="color: #990000">=</span> <span style="color: #FF0000">"flex"</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">-- specify your own path if needed</span></span>
    FLEXOPT <span style="color: #990000">=</span> <span style="color: #FF0000">""</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">-- specify addtional options if needed</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">,</span>

<span style="color: #990000">...</span>

Program <span style="color: #FF0000">{</span>
    <span style="color: #990000">...</span>
    Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        Bison <span style="color: #FF0000">{</span> Source<span style="color: #990000">=</span><span style="color: #FF0000">"grammar.y"</span><span style="color: #990000">,</span> TokenDefines <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span> Pass <span style="color: #990000">=</span> <span style="color: #FF0000">"SomePass"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        Flex <span style="color: #FF0000">{</span> Source<span style="color: #990000">=</span><span style="color: #FF0000">"lexer.l"</span><span style="color: #990000">,</span> Pass <span style="color: #990000">=</span> <span style="color: #FF0000">"SomePass"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Both generators take <code>Source</code> and <code>Pass</code> arguments which are self-explanatory.
The <code>TokenDefines</code> option controls whether bison should generate an additonal
header with token defines. This must be controlled by the generator so that
Tundra knows about this additional output file.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_functional_composition">Functional Composition</h3>
<div class="paragraph"><p>Because unit keywords map to Lua functions, you can easily create
convenience functions on top of them. For example, say that you have many
different static libraries, each following the exact same pattern. Rather than
repeating all those declarations, use a function to remove the duplication:</p></div>
<div class="listingblock">
<div class="title">Unit Function Wrapper Example</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #0000FF">local</span></span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">dolib</span></span><span style="color: #990000">(</span>name<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> StaticLibrary <span style="color: #FF0000">{</span>
        Name <span style="color: #990000">=</span> name<span style="color: #990000">,</span>
        Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> Glob <span style="color: #FF0000">{</span> Dir <span style="color: #990000">=</span> name<span style="color: #990000">,</span> Extensions <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">".c"</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-style: italic"><span style="color: #9A1900">-- we can now say:</span></span>

dolib <span style="color: #FF0000">"foo"</span>
dolib <span style="color: #FF0000">"bar"</span>
dolib <span style="color: #FF0000">"baz"</span>

<span style="font-style: italic"><span style="color: #9A1900">-- or even:</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">for</span></span> _<span style="color: #990000">,</span> name <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> ipairs <span style="color: #FF0000">{</span> <span style="color: #FF0000">"foo"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"bar"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"baz"</span> <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    <span style="font-weight: bold"><span style="color: #000000">dolib</span></span><span style="color: #990000">(</span>name<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_unit_return_values">Unit Return Values</h3>
<div class="paragraph"><p>Whenever you invoke a unit function such as <code>StaticLibrary</code>, the return value
is a data structure that can be used wherever a name or reference to that
library is required. This removes the need to use strings. You should prefer
this style as it is less error prone and slightly faster.</p></div>
<div class="listingblock">
<div class="title">Unit Return Value Example</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #0000FF">local</span></span> mylib <span style="color: #990000">=</span> StaticLibrary <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #0000FF">local</span></span> otherlib <span style="color: #990000">=</span> StaticLibrary <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span>

Program <span style="color: #FF0000">{</span>
    Name <span style="color: #990000">=</span> <span style="color: #FF0000">"main"</span><span style="color: #990000">,</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- ...</span></span>
    Depends <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> mylib<span style="color: #990000">,</span> otherlib <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_environment">The Environment</h2>
<div class="sectionbody">
<div class="paragraph"><p>Tundra uses a hierarchical key-value environment to store information used to
build the commands to run. This design shares some properties with both
Makefile and Jam variables and the SCons environment.</p></div>
<div class="paragraph"><p>Values are always stored as lists (in this way the environment is similar to
Jam variables).</p></div>
<div class="paragraph"><p>Environment strings are typically set in the <code>tundra.lua</code> file and in toolset
scripts but can also be set freely on units (which have their own environments
derived from the global one.)</p></div>
<div class="sect2">
<h3 id="_the_basic_environment">The basic environment</h3>
<div class="paragraph"><p>With no tools or platform settings loaded, the following keys are always available:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>OBJECTROOT</code> - specifies the directory in which variant-specific build
  directories will be created (default: <code>tundra-output</code>)
</p>
</li>
<li>
<p>
<code>SEP</code> - The path separator used on the host platform
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_interpolation">Interpolation</h3>
<div class="paragraph"><p>Basic interpolation is written <code>$(FOO)</code> and just fetches the value associated
with <code>FOO</code> from the environment structure. If <code>FOO</code> is bound to multiple
values, they are joined together with spaces.</p></div>
</div>
<div class="sect2">
<h3 id="_interpolation_options">Interpolation Options</h3>
<div class="paragraph"><p>Tundra includes a number of interpolation shortcuts to build strings from the
environment. For example, to construct a list of include paths
from a environment variable <code>CPPPATH</code>, you can say <code>$(CPPPATH:p-I)</code>.</p></div>
<div class="tableblock">
<table rules="all"
width="90%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 1. Interpolation Syntax</caption>
<col width="30%" />
<col width="69%" />
<thead>
<tr>
<th align="left" valign="top">Syntax                 </th>
<th align="left" valign="top">Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:f)</code></p></td>
<td align="left" valign="top"><p class="table">Convert to forward slashes (<code>/</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:b)</code></p></td>
<td align="left" valign="top"><p class="table">Convert to backward slashes (<code>\</code>)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:n)</code></p></td>
<td align="left" valign="top"><p class="table">Convert to native path slashes for host platform</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:u)</code></p></td>
<td align="left" valign="top"><p class="table">Convert to upper case</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:l)</code></p></td>
<td align="left" valign="top"><p class="table">Convert to lower case</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:B)</code></p></td>
<td align="left" valign="top"><p class="table"><strong>filenames</strong>: Only keep the base part of a filename (w/o extension)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:F)</code></p></td>
<td align="left" valign="top"><p class="table"><strong>filenames</strong>: Only keep the filename (w/o dir)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:D)</code></p></td>
<td align="left" valign="top"><p class="table"><strong>filenames</strong>: Only keep the directory</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:p&lt;prefix&gt;)</code></p></td>
<td align="left" valign="top"><p class="table">Prefix all values with the string <code>&lt;prefix&gt;</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:s&lt;suffix&gt;)</code></p></td>
<td align="left" valign="top"><p class="table">Suffix all values with the string <code>&lt;suffix&gt;</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:[&lt;index&gt;])</code></p></td>
<td align="left" valign="top"><p class="table">Select the item at the (one-based) <code>index</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:j&lt;sep&gt;)</code></p></td>
<td align="left" valign="top"><p class="table">Join all values with <code>&lt;sep&gt;</code> as a separator rather than space</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:A&lt;suffix&gt;)</code></p></td>
<td align="left" valign="top"><p class="table">Suffix all values with <code>&lt;suffix&gt;</code> unless it is already there</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(VAR:P&lt;prefix&gt;)</code></p></td>
<td align="left" valign="top"><p class="table">Prefix all values with <code>&lt;prefix&gt;</code> unless it is already there</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>These interpolation options can be combined arbitrarily by tacking on several
options. If an option parameter contains a colon the colon must be escaped with
a backslash or it will be taken as the start of the next interpolation option.</p></div>
</div>
<div class="sect2">
<h3 id="_interpolation_examples">Interpolation Examples</h3>
<div class="paragraph"><p>Assume there is an environment with the following bindings:</p></div>
<div class="tableblock">
<table rules="all"
width="90%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="10%" />
<col width="90%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>FOO</code></p></td>
<td align="left" valign="top"><p class="table"><code>"String"</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>BAR</code></p></td>
<td align="left" valign="top"><p class="table"><code>{ "A", "B", "C" }</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Then interpolating the following strings will give the associated result:</p></div>
<div class="tableblock">
<table rules="all"
width="90%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="30%" />
<col width="69%" />
<thead>
<tr>
<th align="left" valign="top">Expression             </th>
<th align="left" valign="top">Resulting String</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>$(FOO)</code></p></td>
<td align="left" valign="top"><p class="table"><code>String</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(FOO:u)</code></p></td>
<td align="left" valign="top"><p class="table"><code>STRING</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(FOO:l)</code></p></td>
<td align="left" valign="top"><p class="table"><code>string</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(FOO:p__)</code></p></td>
<td align="left" valign="top"><p class="table"><code>__String</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(FOO:p__:s__)</code></p></td>
<td align="left" valign="top"><p class="table"><code>__String__</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(BAR)</code></p></td>
<td align="left" valign="top"><p class="table"><code>A B C</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(BAR:u)</code></p></td>
<td align="left" valign="top"><p class="table"><code>A B C</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(BAR:l)</code></p></td>
<td align="left" valign="top"><p class="table"><code>a b c</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(BAR:p__)</code></p></td>
<td align="left" valign="top"><p class="table"><code>__A __B __C</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(BAR:p__:s__:j!)</code></p></td>
<td align="left" valign="top"><p class="table"><code>__A__!__B__!__C__</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(BAR:p\::s!)</code></p></td>
<td align="left" valign="top"><p class="table"><code>:A! :B! :C!</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>$(BAR:AC)</code></p></td>
<td align="left" valign="top"><p class="table"><code>AC BC C</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_nested_interpolation">Nested Interpolation</h3>
<div class="paragraph"><p>Nested interpolation is possible, but should be used with care as it can be
hard to debug and understand. Here&#8217;s an example of how the generic C toolchain
inserts compiler options dependening on what variant is currently active:</p></div>
<div class="paragraph"><p><code>$(CCOPTS_$(CURRENT_VARIANT:u))</code></p></div>
<div class="paragraph"><p>This works becase the inner expansion will evalate <code>CURRENT_VARIANT</code> first
(say, it has the value <code>debug</code>). That value is then converted to upper-case and
spliced into the former which yields a new expression <code>$(CCOPTS_DEBUG)</code> which
is then expanded in turn.</p></div>
<div class="paragraph"><p>Used with care this is a powerful way of letting users customize variables per
configuration and then glue everything together with a simple template.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_environment_variables">Environment Variables</h2>
<div class="sectionbody">
<div class="paragraph"><p>These environment variables apply to C-based toolsets:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>CPPPATH</code> - A list of search directories for include files
</p>
</li>
<li>
<p>
<code>CPPDEFS</code> - A list of preprocessor definitions
</p>
</li>
<li>
<p>
<code>LIBS</code> - A list of libraries to link with
</p>
</li>
<li>
<p>
<code>LIBPATH</code> -  A list of search directories for library files
</p>
</li>
<li>
<p>
<code>CC</code> - The C compiler
</p>
</li>
<li>
<p>
<code>CXX</code> - The C++ compiler
</p>
</li>
<li>
<p>
<code>LIB</code> - The program that makes static libraries (archives)
</p>
</li>
<li>
<p>
<code>LD</code> - The linker
</p>
</li>
<li>
<p>
<code>CCOPTS</code> - Common C compiler options for all configurations
</p>
</li>
<li>
<p>
<code>CCOPTS_&lt;config&gt;</code> - Compiler C options for variant <code>&lt;config&gt;</code>, such as <code>CCOPTS_DEBUG</code>, <code>CCOPTS_RELEASE</code>.
</p>
</li>
<li>
<p>
<code>CXXOPTS</code> - Common C++ compiler options for all configurations
</p>
</li>
<li>
<p>
<code>CXXOPTS_&lt;config&gt;</code> - Compiler C++ options for variant <code>&lt;config&gt;</code>, such as <code>CXXOPTS_DEBUG</code>, <code>CXXOPTS_RELEASE</code>.
</p>
</li>
<li>
<p>
<code>CCCOM</code> - Command line for C compilation
</p>
</li>
<li>
<p>
<code>CXXCOM</code> - Command line for C++ compilation
</p>
</li>
<li>
<p>
<code>PCHCOMPILE</code> - Command line for precompiled header compilation
</p>
</li>
<li>
<p>
<code>PROGOPTS</code> - Options specific to linking programs
</p>
</li>
<li>
<p>
<code>PROGCOM</code> - Command line to link a program
</p>
</li>
<li>
<p>
<code>LIBOPTS</code> - Options specific to creating a static library (archive)
</p>
</li>
<li>
<p>
<code>LIBCOM</code> - Command line to create a static library (archive)
</p>
</li>
<li>
<p>
<code>SHLIBOPTS</code> - Options specific to creating a shared library
</p>
</li>
<li>
<p>
<code>SHLIBCOM</code> - Command line to create a shared library
</p>
</li>
<li>
<p>
<code>FRAMEWORKS</code> - (OS X) Frameworks to include and link with
</p>
</li>
<li>
<p>
<code>AUX_FILES_PROGRAM</code>, <code>AUX_FILES_SHAREDLIBRARY</code> - List of patterns that expand to auxilliary files to clean for programs, shared libraries. Useful to clean up debug and map files.
</p>
</li>
</ul></div>
<div class="paragraph"><p>These environment variables apply to .NET-based toolsets:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>CSC</code> - The C# compiler
</p>
</li>
<li>
<p>
<code>CSC_WARNING_LEVEL</code> - The C# warning level
</p>
</li>
<li>
<p>
<code>CSLIBS</code> - Assembly references
</p>
</li>
<li>
<p>
<code>CSRESOURCES</code> - Resource file references
</p>
</li>
<li>
<p>
<code>CSCOPTS</code> - Common options
</p>
</li>
<li>
<p>
<code>CSPROGSUFFIX</code> - The suffix of generated programs, by default <code>.exe</code>
</p>
</li>
<li>
<p>
<code>CSLIBSUFFIX</code> - The suffix of generated libraries, by default`.dll`
</p>
</li>
<li>
<p>
<code>CSRESGEN</code> - The resource compiler
</p>
</li>
<li>
<p>
<code>CSCLIBCOM</code> - Command line to generate a library
</p>
</li>
<li>
<p>
<code>CSCEXECOM</code> - Command line to generate an executable
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_toolsets">Toolsets</h2>
<div class="sectionbody">
<div class="paragraph"><p>This section tries to document the stock toolsets that come included with Tundra.</p></div>
<div class="sect2">
<h3 id="_generic_cpp">generic-cpp</h3>
<div class="paragraph"><p>This isn&#8217;t really a toolset you would import explicity, it is a base layer the
other tools drag in to set up defaults. It has functionality to set up
preprocessor scanners, registers functions to implicitly compile source files
to object files and such. All other C toolsets import this toolset.</p></div>
</div>
<div class="sect2">
<h3 id="_gcc">gcc</h3>
<div class="paragraph"><p>The <code>gcc</code> toolset is a simple GCC toolset that only uses basic options and does
nothing fancy. It is suitable for run-of-the-mill UNIX clones such as Linux,
BSD but also works well for command-line programs on Mac OS X.</p></div>
<div class="paragraph"><p>It formats include paths with <code>-I</code>, preprocessor defines with <code>-D</code> and so on.
It tries to run <code>ar</code> to create static libraries and there is no support for
dynamic libraries.</p></div>
</div>
<div class="sect2">
<h3 id="_gcc_osx_and_clang_osx">gcc-osx and clang-osx</h3>
<div class="paragraph"><p><code>gcc-osx</code> extends the <code>gcc</code> toolset by adding Mac OS X specific options for
frameworks and shared libraries (dylib). <code>clang-osx</code> is just like <code>gcc-osx</code> but
uses the CLang frontend rather than GCC.</p></div>
</div>
<div class="sect2">
<h3 id="_msvc">msvc</h3>
<div class="paragraph"><p>This toolset uses a <code>cl.exe</code> from the environment. It is suitable for direct
use if you want to run with a local MSVC compiler that is already in your path.</p></div>
</div>
<div class="sect2">
<h3 id="_msvc_vs2008">msvc-vs2008</h3>
<div class="paragraph"><p>This toolset imports the <code>msvc</code> toolset but can locate and set up the Visual
Studio 2008 compiler from the registry and explicitly select between 32 and
64-bit versions of the compilers. This gives two advantages:</p></div>
<div class="ulist"><ul>
<li>
<p>
You can just run tundra without setting up the environment with a compiler
  (e.g. through the "Visual Studio Command Prompt" shortcut)
</p>
</li>
<li>
<p>
You can build for multiple target architectures at the same time, for example
  build both x86 and x64 code in batch.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This toolset supports two options:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>HostArch</code>: one of <code>x86</code>, <code>x64</code> or <code>itanium</code>; selects the host architecture
  of the compiler binaries. Defaults to x64 on 64-bit machines, x86 on 32-bit
  machines.
</p>
</li>
<li>
<p>
<code>TargetArch</code>: one of <code>x86</code>, <code>x64</code> or <code>itanium</code>; selects the target architecture
  of the compiler binaries. Defaults to <code>x86</code>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Here&#8217;s an example of how this toolset can be configured for an explicit target
architecture:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    Tools <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">{</span> <span style="color: #FF0000">"msvc-vs2008"</span><span style="color: #990000">;</span> TargetArch <span style="color: #990000">=</span> <span style="color: #FF0000">"itanium"</span><span style="color: #990000">,</span> HostArch <span style="color: #990000">=</span> <span style="color: #FF0000">"x86"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="font-style: italic"><span style="color: #9A1900">-- ...</span></span>
    <span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extending_tundra">Extending Tundra</h2>
<div class="sectionbody">
<div class="paragraph"><p>Tundra can be extended in three ways:</p></div>
<div class="ulist"><ul>
<li>
<p>
By adding a toolset, you can teach Tundra how to invoke a variation of a
  standard toolchain, such as C/C++ or .NET. A toolset configures the
  environment for building.
</p>
</li>
<li>
<p>
By adding syntactic extensions that aid in writing <code>units.lua</code> input. A good
  example of this is the <code>Glob</code> helper which transforms a directory and a set
  of file extensions into a list of source files. Syntactic helpers like <code>Glob</code>
  operate transparently and you can always get the same results by hand.
</p>
</li>
<li>
<p>
By adding unit extensions that implement build actions. Unit extensions can
  range from simple (running a single custom action) to complex (multiple
  nested steps that pipe build results between each other).
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="_adding_toolsets">Adding toolsets</h3>
<div class="paragraph"><p>Toolsets configure a variation of an existing toolset implementation. Currently
the following toolset types can be created:</p></div>
<div class="tableblock">
<table rules="all"
width="90%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="14%" />
<col width="28%" />
<col width="35%" />
<col width="21%" />
<thead>
<tr>
<th align="left" valign="top">Language     </th>
<th align="left" valign="top">Base toolset         </th>
<th align="left" valign="top">Unit driver                </th>
<th align="left" valign="top"> Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Assembly</p></td>
<td align="left" valign="top"><p class="table"><code>generic-asm.lua</code></p></td>
<td align="left" valign="top"><p class="table"><code>tundra.nodegen.native</code></p></td>
<td align="left" valign="top"><p class="table"><code>yasm</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">C and C++</p></td>
<td align="left" valign="top"><p class="table"><code>generic-cpp.lua</code></p></td>
<td align="left" valign="top"><p class="table"><code>tundra.nodegen.native</code></p></td>
<td align="left" valign="top"><p class="table"><code>gcc</code>, <code>msvc</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">.NET</p></td>
<td align="left" valign="top"><p class="table"><code>generic-dotnet.lua</code></p></td>
<td align="left" valign="top"><p class="table"><code>tundra.nodegen.dotnet</code></p></td>
<td align="left" valign="top"><p class="table"><code>mono</code>, <code>dotnet</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Toolset creation typically involves deriving from a base toolset script that
provides you with the common glue for that toolchain type. For example, the
<code>generic-cpp.lua</code> script sets up the implicit build actions for C and C++
files, knows how to configure header scanning and so on. The derived toolset in
the C family mostly configure the environment and possibly query the machine
for compiler/tool locations.</p></div>
<div class="paragraph"><p>Assembly language is currently implemented as an implicit make action that can
convert assembly files to object files, and this needs a C toolset for linking
as well. It is typically the case that you combine C and Assembly anyway, so
this is rarely a problem. If you new toolset is designed to interop with other
native tools, this might be one way to do it.</p></div>
<div class="paragraph"><p>If you are trying to add a completely new language toolchain, you will probably
have to implement a new unit extension set for that toolchain too. This
extension would provide the right primitives to work with your toolset, much
like <code>StaticLibrary</code> and <code>Program</code> are appropriate for the native toolchain.</p></div>
</div>
<div class="sect2">
<h3 id="_adding_syntax_extensions">Adding syntax extensions</h3>
<div class="paragraph"><p>Syntax extensions are a convenience to the build file writer.</p></div>
<div class="sect3">
<h4 id="_lua_syntax_modules">Lua syntax modules</h4>
<div class="paragraph"><p>Here is a skeleton syntax extension module to start from:</p></div>
<div class="listingblock">
<div class="title">Syntax Script Template</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">module</span></span><span style="color: #990000">(...,</span> package<span style="color: #990000">.</span>seeall<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">local</span></span> decl <span style="color: #990000">=</span> require <span style="color: #FF0000">"tundra.decl"</span>

<span style="font-weight: bold"><span style="color: #0000FF">local</span></span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">foo</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">-- Replacement data goes here</span></span>
        C <span style="color: #990000">=</span> args<span style="color: #990000">.</span>A <span style="color: #990000">+</span> args<span style="color: #990000">.</span>B
    <span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-style: italic"><span style="color: #9A1900">-- Add functions to the parser, you can add more than one here</span></span>
decl<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add_function</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Foo"</span><span style="color: #990000">,</span> foo<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Basically the functions you add work as macro transformers. After loading the
syntax extension above, <code>Foo</code> is exposed as a call to your function. The
parsing frontend will substitute whatever you return from <code>foo</code> for the call&#8217;s
body. Using the above example <code>Foo { A = 1, B = 2 }</code> will be replaced by
<code>{ C = 3 }</code>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_using_defrule_to_define_custom_build_rules">Using DefRule to define custom build rules</h3>
<div class="paragraph"><p>DefRule is a declarative way to introduce new DAG-building primitives,
typically by calling out to external tools. Here is a simple example, taken
from the <code>generator-simple</code> example:</p></div>
<div class="listingblock">
<div class="title">DefRule example</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">local</span></span> common <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
    Env <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        GENSCRIPT <span style="color: #990000">=</span> <span style="color: #FF0000">"generate-file.py"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span>

Build <span style="color: #FF0000">{</span>
    Units <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900">-- A rule to call out to a python file generator.</span></span>
        DefRule <span style="color: #FF0000">{</span>
            Name               <span style="color: #990000">=</span> <span style="color: #FF0000">"GenerateFile"</span><span style="color: #990000">,</span>
            Pass               <span style="color: #990000">=</span> <span style="color: #FF0000">"CodeGeneration"</span><span style="color: #990000">,</span>
            ConfigInvariant    <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
            Command            <span style="color: #990000">=</span> <span style="color: #FF0000">"python $(GENSCRIPT) $(&lt;) $(@)"</span><span style="color: #990000">,</span>
            ImplicitInputs     <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"$(GENSCRIPT)"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            Blueprint <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
                Input  <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> Type <span style="color: #990000">=</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span> Required <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                Output <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> Type <span style="color: #990000">=</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span> Required <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            Setup <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>env<span style="color: #990000">,</span> data<span style="color: #990000">)</span>
                <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #FF0000">{</span>
                    InputFiles  <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> data<span style="color: #990000">.</span>Input <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                    OutputFiles <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #FF0000">"$(OBJECTROOT)/"</span> <span style="color: #990000">..</span> data<span style="color: #990000">.</span>Output <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">}</span>
            <span style="font-weight: bold"><span style="color: #0000FF">end</span></span><span style="color: #990000">,</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> testprog <span style="color: #990000">=</span> Program <span style="color: #FF0000">{</span>
            Name <span style="color: #990000">=</span> <span style="color: #FF0000">"testprog"</span><span style="color: #990000">,</span>
            Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"main.c"</span><span style="color: #990000">,</span>
                <span style="font-style: italic"><span style="color: #9A1900">-- Generate a source file, feed the .c file back into the unit</span></span>
                GenerateFile <span style="color: #FF0000">{</span>
                    Input <span style="color: #990000">=</span> <span style="color: #FF0000">"data.txt"</span><span style="color: #990000">,</span>
                    Output <span style="color: #990000">=</span> <span style="color: #FF0000">"data.c"</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #000000">Default</span></span><span style="color: #990000">(</span>testprog<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span><span style="color: #990000">,</span>

    Passes <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        CodeGeneration <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> Name<span style="color: #990000">=</span><span style="color: #FF0000">"Generate sources"</span><span style="color: #990000">,</span> BuildOrder <span style="color: #990000">=</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

    Configs <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
      <span style="font-style: italic"><span style="color: #9A1900">-- ...</span></span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_adding_unit_extensions">Adding unit extensions</h3>
<div class="paragraph"><p>Unit extensions hook capture data during parsing which can later be transformed
into DAG nodes for building. These are more complex than <code>DefRule</code> invocations,
but can do anything.</p></div>
<div class="paragraph"><p>To create one, start with this template script:</p></div>
<div class="listingblock">
<div class="title">Unit Script Template</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">module</span></span><span style="color: #990000">(...,</span> package<span style="color: #990000">.</span>seeall<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">local</span></span> nodegen <span style="color: #990000">=</span> require <span style="color: #FF0000">"tundra.nodegen"</span>

<span style="font-style: italic"><span style="color: #9A1900">-- Create a metatable for this evaluator</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">local</span></span> _mt <span style="color: #990000">=</span> nodegen<span style="color: #990000">.</span>create_eval_subclass <span style="color: #FF0000">{}</span>

<span style="font-style: italic"><span style="color: #9A1900">-- Describe the syntactic form of the unit. This describes the data that is</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- passed into create_dag below after checking.</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">local</span></span> blueprint <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
    Bar <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        Type <span style="color: #990000">=</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">,</span>
        Help <span style="color: #990000">=</span> <span style="color: #FF0000">"The all-important Bar string"</span><span style="color: #990000">,</span>
        Required <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        Type <span style="color: #990000">=</span> <span style="color: #FF0000">"source_list"</span><span style="color: #990000">,</span>
        Help <span style="color: #990000">=</span> <span style="color: #FF0000">"List of sources"</span><span style="color: #990000">,</span>
        Required <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    Frob <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        Type <span style="color: #990000">=</span> <span style="color: #FF0000">"filter_table"</span><span style="color: #990000">,</span>
        Help <span style="color: #990000">=</span> <span style="color: #FF0000">"Optional bag of data"</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- ...</span></span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">-- This function will be called once for every invocation, for each</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- configuration in the build.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">--</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- env - The unit's private environment</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- data - Transformed invocation data according to blueprint</span></span>
<span style="font-style: italic"><span style="color: #9A1900">-- deps - Dependencies picked up through invocation</span></span>
<span style="font-style: italic"><span style="color: #9A1900">--        (e.g. nested build jobs from sources and such)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">_mt:create_dag</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> data<span style="color: #990000">,</span> deps<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> env<span style="color: #990000">:</span>make_node <span style="color: #FF0000">{</span>
        Label <span style="color: #990000">=</span> <span style="color: #FF0000">"Foo $(@)"</span><span style="color: #990000">,</span>
        Action <span style="color: #990000">=</span> <span style="color: #FF0000">"$(MYACTION)"</span><span style="color: #990000">,</span>
        Inputs <span style="color: #990000">=</span> <span style="color: #990000">...,</span>
        Outputs <span style="color: #990000">=</span> <span style="color: #990000">...,</span>
        ImplicitInputs <span style="color: #990000">=</span> <span style="color: #990000">...,</span>
        Dependencies <span style="color: #990000">=</span> deps<span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-style: italic"><span style="color: #9A1900">-- Add evaluator</span></span>
nodegen<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add_evaluator</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Foo"</span><span style="color: #990000">,</span> _mt<span style="color: #990000">,</span> blueprint<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>In the metatable passed to <code>nodegen.create_eval_subclass</code> you can tag on a few
additional parameter that control the data transformation functionality in the
underlying layer.</p></div>
<div class="paragraph"><p>If you include a key <code>DeclToEnvMappings</code>, the nodegen will accept shortcut
mappings directly to environment data. This is how <code>Defines</code> maps to <code>CPPDEFS</code>
in the native toolset, for example.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">local</span></span> _native_mt <span style="color: #990000">=</span> nodegen<span style="color: #990000">.</span>create_eval_subclass <span style="color: #FF0000">{</span>
    DeclToEnvMappings <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        Libs <span style="color: #990000">=</span> <span style="color: #FF0000">"LIBS"</span><span style="color: #990000">,</span>
        Defines <span style="color: #990000">=</span> <span style="color: #FF0000">"CPPDEFS"</span><span style="color: #990000">,</span>
        Includes <span style="color: #990000">=</span> <span style="color: #FF0000">"CPPPATH"</span><span style="color: #990000">,</span>
        Frameworks <span style="color: #990000">=</span> <span style="color: #FF0000">"FRAMEWORKS"</span><span style="color: #990000">,</span>
        LibPaths <span style="color: #990000">=</span> <span style="color: #FF0000">"LIBPATH"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The blueprint mechanism saves you from having to validate user input in your
build function. In addition to the keys you list for your unit, the following
keys are always added for consistency:</p></div>
<div class="tableblock">
<table rules="all"
width="90%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="30%" />
<col width="69%" />
<thead>
<tr>
<th align="left" valign="top">Key            </th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>Propagate</code></p></td>
<td align="left" valign="top"><p class="table">Implements environment/keyword propagation to dependencies</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>Env</code></p></td>
<td align="left" valign="top"><p class="table">Environment data to append</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>ReplaceEnv</code></p></td>
<td align="left" valign="top"><p class="table">Environment data to replace</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>Depends</code></p></td>
<td align="left" valign="top"><p class="table">List of unit dependencies</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>Pass</code></p></td>
<td align="left" valign="top"><p class="table">The pass the unit should build in</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>SourceDir</code></p></td>
<td align="left" valign="top"><p class="table">An alternate source directory, used for all <code>source_list</code> data</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>Config</code></p></td>
<td align="left" valign="top"><p class="table">Configuration filter</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>SubConfigs</code></p></td>
<td align="left" valign="top"><p class="table">Sub-configuration filter</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>This means you should never list them in your blueprint as they are always
added to all units. They are handled internally in the <code>nodegen</code> layer but you
are welcome to reading the data in your <code>create_dag</code> implementation, especially
<code>Pass</code> and <code>Depends</code> are often useful.</p></div>
<div class="paragraph"><p>When filling in your data blueprint, the following types are supported:</p></div>
<div class="tableblock">
<table rules="all"
width="90%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="30%" />
<col width="69%" />
<thead>
<tr>
<th align="left" valign="top">Type name      </th>
<th align="left" valign="top">Accepted values</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>string</code></p></td>
<td align="left" valign="top"><p class="table">Any string value</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>boolean</code></p></td>
<td align="left" valign="top"><p class="table">Boolean <code>true</code> or <code>false</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>table</code></p></td>
<td align="left" valign="top"><p class="table">Any table value, or single string which will be wrapped in table</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>filter_table</code></p></td>
<td align="left" valign="top"><p class="table">Table which will be configuration filtered</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>source_list</code></p></td>
<td align="left" valign="top"><p class="table">Table which is taken to contain source files (implicit actions will be run).
                 Pass in the name of an environment variable in <code>ExtensionKey</code> to control which
                 source extensions are accepted. Other source files will be discarded.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>pass</code></p></td>
<td align="left" valign="top"><p class="table">A valid pass name string</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>depends</code></p></td>
<td align="left" valign="top"><p class="table">A list of names or unit references</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Data is transformed before being passed to the <code>create_dag</code> function:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>filter_table</code> data is filtered for the current build id (<code>BUILD_ID</code> in the env).
</p>
</li>
<li>
<p>
<code>source_list</code> data becomes a list of filenames that might have been derived through
  multiple steps of implicit compilation steps. If other nodes are involved in
  producing these files, they will appear in the <code>deps</code> parameter.
</p>
</li>
<li>
<p>
<code>pass</code> data becomes a guaranteed valid pass object, or <code>nil</code> meaning the
  default pass. This is intended so you can just send it straight through to
  <code>env:make_node</code>.
</p>
</li>
<li>
<p>
<code>depends</code> data is transformed into a list of unit data references.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The new unit we have defined above can now be used like this wherever a unit is
called for:</p></div>
<div class="listingblock">
<div class="title">Unit Usage Example</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #0000FF">local</span></span> f <span style="color: #990000">=</span> Foo <span style="color: #FF0000">{</span>
    Bar <span style="color: #990000">=</span> <span style="color: #FF0000">"meh"</span><span style="color: #990000">,</span>
    Sources <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> <span style="color: #990000">...</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="font-style: italic"><span style="color: #9A1900">-- ...</span></span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2020-10-22 21:46:35 UTC
</div>
</div>
</body>
</html>
